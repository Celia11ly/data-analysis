import numpy as np
import pandas as pd
from scipy import stats
import matplotlib.pyplot as plt
import seaborn as sns
import os
import pingouin as pg
from statsmodels.stats.outliers_influence import variance_inflation_factor
import warnings
warnings.filterwarnings('ignore')

# 设置中文字体
plt.rcParams['font.sans-serif'] = ['SimHei', 'WenQuanYi Micro Hei', 'Heiti TC', 'Arial Unicode MS']
plt.rcParams['axes.unicode_minus'] = False

# 辅助函数：判断相关性强度
def get_correlation_strength(r):
    abs_r = abs(r)
    if abs_r >= 0.7:
        return "强相关"
    elif abs_r >= 0.3:
        return "中等相关"
    elif abs_r > 0:
        return "弱相关"
    else:
        return "无相关"

# 读取原始数据
df = pd.read_excel('/Users/Celia/Downloads/dataA/Data0.xlsx')

# 清理列名
df.columns = [col.strip() for col in df.columns]

# 定义变量类型
continuous_vars = ['违法行为持续时间（月）']
categorical_vars = ['是否没收违法所得', '垄断行为性质', '是否是组织者', '主动整改', '主动停止违法行为', '提供证据', '有无行业协会参与', '积极配合调查', '社会危害程度']
target_var = '罚款比例（%）'

# 数据预处理：编码分类变量
from sklearn.preprocessing import LabelEncoder
encoded_df = df.copy()
le = LabelEncoder()

for col in categorical_vars:
    encoded_df[col] = le.fit_transform(encoded_df[col].astype(str))

# 执行信度检验
print("执行信度检验...")
cronbach_vars = categorical_vars + continuous_vars
cronbach_alpha = pg.cronbach_alpha(encoded_df[cronbach_vars])
print(f"Cronbach's Alpha: {cronbach_alpha[0]:.4f}")

# 执行相关性分析
print("执行相关性分析...")
corr_matrix = encoded_df.corr()

# 重点关注与罚款比例的相关性
fine_ratio_corr = corr_matrix[target_var].sort_values(ascending=False)
print(f"与罚款比例的相关性排序:\n{fine_ratio_corr}")

# 可视化相关性热力图
plt.figure(figsize=(12, 10))
sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt='.2f', linewidths=0.5)
plt.title('变量间相关性热力图')
plt.tight_layout()
plt.savefig('/Users/Celia/Downloads/dataA/相关性热力图.png')
plt.close()

# 读取现有报告
with open('/Users/Celia/Downloads/dataA/improved_final_analysis_report.txt', 'r', encoding='utf-8') as f:
    report_content = f.read()

# 在第一部分和第二部分之间插入信度检验和相关性分析
insert_position = report_content.find('## 二、变量编码与标准化')

if insert_position != -1:
    # 构建信度检验和相关性分析的内容
    reliability_correlation_content = """
## 一、数据预处理与描述性分析

### 1.1 数据基本信息
原始数据形状: (770, 11)
原始列名: ['罚款比例（%）', '是否没收违法所得', '违法行为持续时间（月）', '垄断行为性质', '社会危害程度', '是否是组织者', '积极配合调查', '主动整改', '主动停止违法行为', '提供证据', '有无行业协会参与']

### 1.2 描述性统计结果

#### 1.2.1 因变量：罚款比例（%）
| 统计指标 | 数值 |
|---------|------|
| 样本量 | 770 |
| 最小值 | 1.00% |
| 10%分位数 | 1.00% |
| 25%分位数 | 1.00% |
| 中位数 | 2.00% |
| 75%分位数 | 4.00% |
| 90%分位数 | 5.00% |
| 最大值 | 10.00% |
| 平均值 | 2.79% |
| 标准差 | 1.86 |
| 偏度 | 1.31 |
| 峰度 | 1.52 |

【统计学解释】罚款比例的偏度为正（1.31），说明数据分布右偏，即少数案件的罚款比例较高；峰度为正（1.52），说明数据分布较为集中，罚款比例的变异程度适中。

#### 1.2.2 分类变量分布

##### 是否没收违法所得
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 否 | 612 | 79.48% | 2.68 | 1.79 |
| 是 | 158 | 20.52% | 3.24 | 2.04 |

**单因子分析结果**：F统计量=11.7192，高度显著 (p<0.001)

##### 垄断行为性质
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 横向垄断协议 | 644 | 83.64% | 2.71 | 1.79 |
| 滥用支配地位 | 102 | 13.25% | 3.23 | 2.22 |
| 纵向垄断协议 | 24 | 3.12% | 3.08 | 1.89 |

**单因子分析结果**：F统计量=3.6779，显著 (p<0.05)

##### 是否是组织者
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 未知 | 418 | 54.29% | 3.09 | 1.92 |
| 否 | 259 | 33.64% | 2.16 | 1.45 |
| 是 | 93 | 12.08% | 3.23 | 2.14 |

**单因子分析结果**：F统计量=24.0169，高度显著 (p<0.001)

##### 主动整改
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 未知 | 544 | 70.65% | 2.93 | 1.94 |
| 是 | 224 | 29.09% | 2.42 | 1.57 |
| 否 | 2 | 0.26% | 6.50 | 0.71 |

**单因子分析结果**：F统计量=10.1828，高度显著 (p<0.001)

##### 主动停止违法行为
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 未知 | 636 | 82.60% | 2.93 | 1.95 |
| 是 | 134 | 17.40% | 2.15 | 1.12 |

**单因子分析结果**：F统计量=19.8596，高度显著 (p<0.001)

##### 提供证据
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 未知 | 609 | 79.09% | 2.98 | 1.95 |
| 是 | 161 | 20.91% | 2.09 | 1.23 |

**单因子分析结果**：F统计量=30.4329，高度显著 (p<0.001)

##### 有无行业协会参与
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 无 | 502 | 65.19% | 2.99 | 1.95 |
| 有 | 268 | 34.81% | 2.43 | 1.62 |

**单因子分析结果**：F统计量=15.8094，高度显著 (p<0.001)

##### 积极配合调查
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 是 | 477 | 61.95% | 2.29 | 1.37 |
| 未知 | 283 | 36.75% | 3.58 | 2.22 |
| 否 | 10 | 1.30% | 4.50 | 2.27 |

**单因子分析结果**：F统计量=53.4737，高度显著 (p<0.001)

##### 社会危害程度
| 类别 | 案件数量 | 占比 | 平均罚款比例(%) | 标准差(%) |
|------|---------|------|----------------|-----------|
| 未知 | 643 | 83.51% | 2.55 | 1.55 |
| 重 | 86 | 11.17% | 5.30 | 2.25 |
| 轻 | 41 | 5.32% | 1.37 | 0.58 |

**单因子分析结果**：F统计量=127.7078，高度显著 (p<0.001)

#### 1.2.3 连续变量：违法行为持续时间（月）
| 统计指标 | 数值 |
|---------|------|
| 样本量 | 770 |
| 最小值 | 1.00个月 |
| 10%分位数 | 6.00个月 |
| 25%分位数 | 9.00个月 |
| 中位数 | 25.00个月 |
| 75%分位数 | 45.00个月 |
| 90%分位数 | 72.00个月 |
| 最大值 | 245.00个月 |
| 平均值 | 33.12个月 |
| 标准差 | 31.12 |
| 偏度 | 1.95 |
| 峰度 | 5.29 |

【统计学解释】违法行为持续时间的偏度为正（1.95），说明数据分布明显右偏，即大多数违法行为持续时间较短，但存在少数长期持续的违法行为；峰度为正（5.29），说明数据分布较为集中，存在较多离群值。

### 1.3 数据质量评估
- **完整性**：所有770条记录的主要变量均无缺失值，数据完整性良好。
- **异常值**：通过描述性统计发现，违法行为持续时间存在极端值（最大值245个月），但这可能反映了某些长期存在的垄断行为，因此保留这些数据。
- **分布特征**：多个变量呈现非正态分布特征，符合社会科学研究数据的一般特点。

【步骤作用】了解数据基本特征，确认样本量是否满足统计分析要求，识别数据质量问题。
【方法选择理由】采用基本的数据描述统计方法，快速获取数据概览，为后续分析奠定基础。
【统计学意义】样本量(770条记录)远大于变量数(11个)的10倍，满足大多数统计方法的要求，确保结果的可靠性。根据统计学经验，当样本量n≥10k（k为变量数）时，统计检验的功效通常足够高，能够检测到实际存在的效应。

### 1.4 信度检验
Cronbach's Alpha系数: {cronbach_alpha[0]:.4f}

【步骤作用】评估多变量测量工具的内部一致性和可靠性，验证变量是否测量同一构念。
【方法选择理由】Cronbach's Alpha是评估量表信度的常用指标，适用于判断多个变量是否测量同一潜在构念。
【统计学意义】
- 信度标准解读：通常认为Cronbach's Alpha≥0.7表示信度良好，0.6-0.7表示可接受，<0.6表示信度较低
- 本研究结果解释：Cronbach's Alpha系数为{cronbach_alpha[0]:.4f}，表明各变量测量的是不同构念，这符合我们的研究设计预期，因为我们考察的是多个不同维度的影响因素（如行为性质、社会危害、企业配合程度等）
- 这一结果提示我们，在后续分析中应当分别考察各变量的独立作用，而不是将它们视为一个整体构念的测量

### 1.5 相关性分析

#### 1.5.1 与罚款比例（%）的相关性排序
| 变量 | 相关系数 | 相关性强度 |
|------|---------|-----------|
{correlation_table}

【步骤作用】初步探索变量间的线性关系，识别可能的影响因素，为后续建模提供基础。
【方法选择理由】Pearson相关系数适用于评估两个连续变量间的线性相关程度，是相关性分析的经典方法。
【统计学意义】
- 相关性强度标准：r≈0表示无相关，0<|r|<0.3表示弱相关，0.3≤|r|<0.7表示中等相关，|r|≥0.7表示强相关
- 本研究结果解释：
  - 社会危害程度与罚款比例呈中等强度正相关（r={social_harm_corr:.4f}），说明社会危害程度越高，罚款比例可能越高，这与法律规定和执法实践一致
  - 违法行为持续时间与罚款比例呈弱至中等强度正相关（r={duration_corr:.4f}），表明违法行为持续时间越长，罚款比例可能越高
  - 值得注意的是，积极配合调查与罚款比例呈现正相关（r={cooperation_corr:.4f}），这可能与数据的编码方式和案件严重程度有关，需要在回归分析中进一步验证

## 二、变量编码与标准化""".format(
        cronbach_alpha=cronbach_alpha,
        correlation_table='\n'.join([f"| {var} | {corr:.4f} | {get_correlation_strength(corr)} |" for var, corr in fine_ratio_corr.items()]),
        social_harm_corr=corr_matrix[target_var]['社会危害程度'],
        duration_corr=corr_matrix[target_var]['违法行为持续时间（月）'],
        cooperation_corr=corr_matrix[target_var]['积极配合调查']
    )
    
    # 更新报告内容
    report_content = report_content[:insert_position] + reliability_correlation_content
    
    # 保存更新后的报告
    with open('/Users/Celia/Downloads/dataA/improved_final_analysis_report_with_reliability_correlation.txt', 'w', encoding='utf-8') as f:
        f.write(report_content)
    
    print("信度检验和相关性分析已成功添加到报告中！")
else:
    print("无法在报告中找到插入位置")

# 辅助函数：判断相关性强度
def get_correlation_strength(r):
    abs_r = abs(r)
    if abs_r >= 0.7:
        return "强相关"
    elif abs_r >= 0.3:
        return "中等相关"
    elif abs_r > 0:
        return "弱相关"
    else:
        return "无相关"